<template>
	<div :style="{ backgroundColor: trackColor, height: height + 'px', borderRadius: borderRadius + 'px' }" class="w-full overflow-hidden">
		<div
			:style="{
				width: Math.max(0, Math.min(displayPercent, 100)) + '%',
				backgroundColor: fillColor,
				height: '100%',
				borderRadius: borderRadius + 'px'
			}"
		></div>
	</div>
</template>


<script>
export default {
	props: {
		percent: { type: Number, required: true },
		height: { type: Number, default: 12 },
		fillColor: { type: String, default: '#059669' },
		trackColor: { type: String, default: '#eef2f3' },
		animate: { type: Boolean, default: true },
		duration: { type: Number, default: 600 }
	},

	data() {
		return {
			displayPercent: 0
		};
	},

	computed: {
		borderRadius() {
			return Math.round(this.height / 2);
		}
	},

	mounted() {
		if (this.animate) {
			// animate from 0 to target
			this.animateTo(this.percent);
		} else {
			this.displayPercent = Math.max(0, Math.min(this.percent, 100));
		}
	},

	watch: {
		percent(newVal) {
			if (this.animate) {
				this.animateTo(newVal);
			} else {
				this.displayPercent = Math.max(0, Math.min(newVal, 100));
			}
		}
	},

	methods: {
		animateTo(target) {
			target = Math.max(0, Math.min(target, 100));
			const start = this.displayPercent;
			const delta = target - start;
			const duration = Math.max(0, this.duration);
			if (duration === 0 || delta === 0) {
				this.displayPercent = target;
				return;
			}

			const startTime = performance.now();

			const step = (now) => {
				const t = Math.min(1, (now - startTime) / duration);
				// easeOutCubic
				const eased = 1 - Math.pow(1 - t, 3);
				this.displayPercent = +(start + delta * eased).toFixed(2);
				if (t < 1) requestAnimationFrame(step);
				else this.displayPercent = target;
			};

			requestAnimationFrame(step);
		}
	}
};
</script>